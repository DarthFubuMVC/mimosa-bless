var bless, blessAll, blessFile, checkForBless, cleanBlessed, color, fs, gatherFiles, logger, path, printObj, trackCompletion, wrench, _, _ref;

bless = require('bless');

fs = require('fs');

path = require('path');

logger = require('logmimosa');

color = require('ansi-color').set;

_ = require('lodash');

wrench = require('wrench');

_ref = require('./util'), printObj = _ref.printObj, trackCompletion = _ref.trackCompletion;

blessFile = function(input, output, options, next) {
  if (!fs.existsSync(input)) {
    return logger.warn("mimosa-bless: bless file [[ " + input + " ]] does not exist");
  }
  logger.info("Blessing [[ " + input + " ]]");
  return fs.readFile(input, 'utf-8', function(e, data) {
    var settings;
    if (e) {
      logger.error("blessc: " + e.message);
      next();
    }
    settings = {
      output: output,
      options: options
    };
    return new bless.Parser(settings).parse(data, function(err, files, numSelectors) {
      var numFiles;
      if (err) {
        logger.error("blessc: " + e.message);
        return next();
      } else {
        numFiles = files.length;
        logger.info("Source CSS file [[ " + input + " ]] contained " + numSelectors + " selectors");
        if (numFiles > 1 || input !== output) {
          _.each(files, function(file) {
            var fd;
            fd = fs.openSync(file.filename, 'w');
            return fs.writeSync(fd, file.content, 0, 'utf-8');
          });
          return logger.success(" " + numFiles + " CSS files created for " + input);
        } else {
          return logger.success("No changes made.");
        }
      }
    });
  });
};

cleanBlessed = function(mimosaConfig, options, next) {
  return next();
};

checkForBless = function(mimosaConfig, options, next) {
  return next();
};

gatherFiles = function(filesFromOptions) {
  return _(filesFromOptions).map(function(entry) {
    if (fs.statSync(entry).isDirectory()) {
      return wrench.readdirSyncRecursive(entry).filter(function(f) {
        return (path.extname(f)) === ".css";
      }).map(function(f) {
        return path.join(entry, f);
      });
    } else {
      return [entry];
    }
  }).flatten().uniq().value();
};

blessAll = function(mimosaConfig, options, next) {
  var files, finish, settings, sources, uniqueInputs;
  settings = mimosaConfig.bless.options;
  logger.info("Blessing files");
  files = gatherFiles(mimosaConfig.bless.files);
  logger.debug("bless files: " + files);
  sources = _.map(files, function(value, key) {
    var input, output;
    input = _.isString(key) ? key : value;
    output = value;
    return {
      input: input,
      output: output
    };
  });
  uniqueInputs = _.map(sources, function(_arg) {
    var input, output;
    input = _arg.input, output = _arg.output;
    return input;
  });
  finish = trackCompletion("blessSources", uniqueInputs, next);
  return _.each(sources, function(_arg) {
    var input, output;
    input = _arg.input, output = _arg.output;
    return blessFile(input, output, settings, function() {
      return finish(input);
    });
  });
};

module.exports = {
  blessAll: blessAll,
  checkForBless: checkForBless,
  cleanBlessed: cleanBlessed
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYzpcXGhvbWVcXGdpdGh1YlxcbWltb3NhLWJsZXNzXFxsaWJcXGJsZXNzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjOlxcaG9tZVxcZ2l0aHViXFxtaW1vc2EtYmxlc3NcXHNyY1xcYmxlc3Nlci5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBQSx5SUFBQTs7QUFBQSxLQUFBLEdBQVEsT0FBQSxDQUFRLE9BQVIsQ0FBUixDQUFBOztBQUFBLEVBQ0EsR0FBSyxPQUFBLENBQVEsSUFBUixDQURMLENBQUE7O0FBQUEsSUFFQSxHQUFPLE9BQUEsQ0FBUSxNQUFSLENBRlAsQ0FBQTs7QUFBQSxNQUdBLEdBQVMsT0FBQSxDQUFRLFdBQVIsQ0FIVCxDQUFBOztBQUFBLEtBSUEsR0FBUSxPQUFBLENBQVEsWUFBUixDQUFxQixDQUFDLEdBSjlCLENBQUE7O0FBQUEsQ0FLQSxHQUFJLE9BQUEsQ0FBUSxRQUFSLENBTEosQ0FBQTs7QUFBQSxNQU1BLEdBQVMsT0FBQSxDQUFRLFFBQVIsQ0FOVCxDQUFBOztBQUFBLE9BTzhCLE9BQUEsQ0FBUSxRQUFSLENBQTlCLEVBQUMsZ0JBQUEsUUFBRCxFQUFXLHVCQUFBLGVBUFgsQ0FBQTs7QUFBQSxTQVNBLEdBQVksU0FBQyxLQUFELEVBQVEsTUFBUixFQUFnQixPQUFoQixFQUF5QixJQUF6QixHQUFBO0FBQ1YsRUFBQSxJQUFBLENBQUEsRUFBUyxDQUFDLFVBQUgsQ0FBYyxLQUFkLENBQVA7QUFDRSxXQUFPLE1BQU0sQ0FBQyxJQUFQLENBQWEsOEJBQUEsR0FBNkIsS0FBN0IsR0FBb0Msb0JBQWpELENBQVAsQ0FERjtHQUFBO0FBQUEsRUFHQSxNQUFNLENBQUMsSUFBUCxDQUFhLGNBQUEsR0FBYSxLQUFiLEdBQW9CLEtBQWpDLENBSEEsQ0FBQTtTQUtBLEVBQUUsQ0FBQyxRQUFILENBQVksS0FBWixFQUFtQixPQUFuQixFQUE0QixTQUFDLENBQUQsRUFBSSxJQUFKLEdBQUE7QUFDMUIsUUFB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QUFBLENBQU8sS0FBUCxFQUFOO0lBQUEsQ0FBbkMsRUFEYztFQUFBLENBQWhCLEVBakJTO0FBQUEsQ0ExRFgsQ0FBQTs7QUFBQSxNQThFTSxDQUFDLE9BQVAsR0FBaUI7QUFBQSxFQUFDLFVBQUEsUUFBRDtBQUFBLEVBQVcsZUFBQSxhQUFYO0FBQUEsRUFBMEIsY0FBQSxZQUExQjtDQTlFakIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImJsZXNzID0gcmVxdWlyZSAnYmxlc3MnXHJcbmZzID0gcmVxdWlyZSAnZnMnXHJcbnBhdGggPSByZXF1aXJlICdwYXRoJ1xyXG5sb2dnZXIgPSByZXF1aXJlICdsb2dtaW1vc2EnXHJcbmNvbG9yID0gcmVxdWlyZSgnYW5zaS1jb2xvcicpLnNldFxyXG5fID0gcmVxdWlyZSAnbG9kYXNoJ1xyXG53cmVuY2ggPSByZXF1aXJlICd3cmVuY2gnXHJcbntwcmludE9iaiwgdHJhY2tDb21wbGV0aW9ufSA9IHJlcXVpcmUgJy4vdXRpbCdcclxuXHJcbmJsZXNzRmlsZSA9IChpbnB1dCwgb3V0cHV0LCBvcHRpb25zLCBuZXh0KSAtPlxyXG4gIHVubGVzcyBmcy5leGlzdHNTeW5jIGlucHV0XHJcbiAgICByZXR1cm4gbG9nZ2VyLndhcm4gXCJtaW1vc2EtYmxlc3M6IGJsZXNzIGZpbGUgW1sgI3tpbnB1dH0gXV0gZG9lcyBub3QgZXhpc3RcIlxyXG5cclxuICBsb2dnZXIuaW5mbyBcIkJsZXNzaW5nIFtbICN7aW5wdXR9IF1dXCJcclxuXHJcbiAgZnMucmVhZEZpbGUgaW5wdXQsICd1dGYtOCcsIChlLCBkYXRhKSAtPlxyXG4gICAgaWYgKGUpXHJcbiAgICAgIGxvZ2dlci5lcnJvciBcImJsZXNzYzogXCIgKyBlLm1lc3NhZ2VcclxuICAgICAgbmV4dCgpXHJcblxyXG4gICAgc2V0dGluZ3MgPSB7b3V0cHV0LCBvcHRpb25zfVxyXG5cclxuICAgIG5ldyBibGVzcy5QYXJzZXIoc2V0dGluZ3MpLnBhcnNlIGRhdGEsIChlcnIsIGZpbGVzLCBudW1TZWxlY3RvcnMpIC0+XHJcbiAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgbG9nZ2VyLmVycm9yIFwiYmxlc3NjOiBcIiArIGUubWVzc2FnZVxyXG4gICAgICAgIG5leHQoKVxyXG4gICAgICBlbHNlXHJcbiAgICAgICAgbnVtRmlsZXMgPSBmaWxlcy5sZW5ndGhcclxuICAgICAgICBsb2dnZXIuaW5mbyBcIlNvdXJjZSBDU1MgZmlsZSBbWyAje2lucHV0fSBdXSBjb250YWluZWQgI3tudW1TZWxlY3RvcnN9IHNlbGVjdG9yc1wiXHJcbiAgICAgICAgaWYgKG51bUZpbGVzID4gMSB8fCBpbnB1dCAhPSBvdXRwdXQpXHJcbiAgICAgICAgICBfLmVhY2ggZmlsZXMsIChmaWxlKSAtPlxyXG4gICAgICAgICAgICBmZCA9IGZzLm9wZW5TeW5jIGZpbGUuZmlsZW5hbWUsICd3J1xyXG4gICAgICAgICAgICBmcy53cml0ZVN5bmMgZmQsIGZpbGUuY29udGVudCwgMCwgJ3V0Zi04J1xyXG5cclxuICAgICAgICAgIGxvZ2dlci5zdWNjZXNzIFwiICN7bnVtRmlsZXN9IENTUyBmaWxlcyBjcmVhdGVkIGZvciAje2lucHV0fVwiXHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgbG9nZ2VyLnN1Y2Nlc3MgXCJObyBjaGFuZ2VzIG1hZGUuXCJcclxuXHJcbmNsZWFuQmxlc3NlZCA9IChtaW1vc2FDb25maWcsIG9wdGlvbnMsIG5leHQpIC0+XHJcbiAgI1RPRE86IGNsZWFuIHVwIGFueSBnZW5lcmF0ZWQgYmxlc3MgZmlsZXNcclxuICBuZXh0KClcclxuXHJcbmNoZWNrRm9yQmxlc3MgPSAobWltb3NhQ29uZmlnLCBvcHRpb25zLCBuZXh0KSAtPlxyXG4gICNUT0RPOiBzdXBwb3J0IGJsZXNzaW5nIGluIHdhdGNoIG1vZGUgaWYgZmlsZXMgZ2V0IGFkZGVkXHJcbiAgbmV4dCgpXHJcblxyXG5nYXRoZXJGaWxlcyA9IChmaWxlc0Zyb21PcHRpb25zKSAtPlxyXG4gIF8gZmlsZXNGcm9tT3B0aW9uc1xyXG4gICAgLm1hcCAoZW50cnkpIC0+XHJcbiAgICAgIGlmIGZzLnN0YXRTeW5jKGVudHJ5KS5pc0RpcmVjdG9yeSgpXHJcbiAgICAgIHRoZW4gd3JlbmNoLnJlYWRkaXJTeW5jUmVjdXJzaXZlKGVudHJ5KS5maWx0ZXIgKGYpIC0+XHJcbiAgICAgICAgKHBhdGguZXh0bmFtZSBmKSA9PSBcIi5jc3NcIlxyXG4gICAgICAubWFwIChmKSAtPiBwYXRoLmpvaW4gZW50cnksIGZcclxuICAgICAgZWxzZSBbZW50cnldXHJcbiAgICAuZmxhdHRlbigpXHJcbiAgICAudW5pcSgpXHJcbiAgICAudmFsdWUoKVxyXG5cclxuYmxlc3NBbGwgPSAobWltb3NhQ29uZmlnLCBvcHRpb25zLCBuZXh0KSAtPlxyXG4gIHNldHRpbmdzID0gbWltb3NhQ29uZmlnLmJsZXNzLm9wdGlvbnNcclxuICBsb2dnZXIuaW5mbyBcIkJsZXNzaW5nIGZpbGVzXCJcclxuICBmaWxlcyA9IGdhdGhlckZpbGVzIG1pbW9zYUNvbmZpZy5ibGVzcy5maWxlc1xyXG5cclxuICBsb2dnZXIuZGVidWcgXCJibGVzcyBmaWxlczogI3tmaWxlc31cIlxyXG5cclxuICAjVE9ETzogc3VwcG9ydCBvdXRwdXQgcGVyIGZpbGVuYW1lIHZpYSBvYmplY3QgZW50cnkgaWYgZGVzaXJlZFxyXG4gIHNvdXJjZXMgPSBfLm1hcCBmaWxlcywgKHZhbHVlLCBrZXkpIC0+XHJcbiAgICBpbnB1dCA9IGlmIF8uaXNTdHJpbmcoa2V5KSB0aGVuIGtleSBlbHNlIHZhbHVlXHJcbiAgICBvdXRwdXQgPSB2YWx1ZVxyXG4gICAge2lucHV0LCBvdXRwdXR9XHJcblxyXG4gIHVuaXF1ZUlucHV0cyA9IF8ubWFwIHNvdXJjZXMsICh7aW5wdXQsIG91dHB1dH0pIC0+IGlucHV0XHJcblxyXG4gIGZpbmlzaCA9IHRyYWNrQ29tcGxldGlvbiBcImJsZXNzU291cmNlc1wiLCB1bmlxdWVJbnB1dHMsIG5leHRcclxuXHJcbiAgXy5lYWNoIHNvdXJjZXMsICh7aW5wdXQsIG91dHB1dH0pIC0+XHJcbiAgICBibGVzc0ZpbGUgaW5wdXQsIG91dHB1dCwgc2V0dGluZ3MsICgpIC0+IGZpbmlzaChpbnB1dClcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge2JsZXNzQWxsLCBjaGVja0ZvckJsZXNzLCBjbGVhbkJsZXNzZWR9XHJcbiJdfQ==
